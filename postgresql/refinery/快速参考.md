# Refinery 快速参考卡

## 🚀 快速开始

### 1. 安装
```bash
cargo install refinery_cli
```

### 2. 初始化配置
```bash
refinery setup
# 选择: 2 (PostgreSQL) → localhost → 5432 → sxt → default → postgres
```

### 3. 创建迁移文件
```bash
# 命名格式: V{版本}__{描述}.sql
touch migrations/V001__initial_schema.sql
```

### 4. 执行迁移
```bash
refinery migrate                    # 执行所有迁移
refinery migrate -f                 # 干运行（仅预览）
refinery migrate -g                 # 事务性迁移
refinery migrate -t 5               # 迁移到版本5
```

## 📝 常用命令

| 命令 | 说明 |
|------|------|
| `refinery setup` | 初始化配置文件 |
| `refinery migrate` | 执行迁移 |
| `refinery migrate -f` | 干运行模式 |
| `refinery migrate -g` | 事务模式 |
| `refinery migrate -t N` | 迁移到版本N |
| `refinery migrate -d` | 严格模式（检查分歧） |
| `refinery migrate -m` | 严格模式（检查缺失） |

## 🗃️ 迁移文件模板

### 基础表创建
```sql
-- V001__create_users.sql
CREATE TABLE IF NOT EXISTS users (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    email VARCHAR(100) UNIQUE NOT NULL,
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
);
```

### 添加列
```sql
-- V002__add_user_avatar.sql
ALTER TABLE users ADD COLUMN IF NOT EXISTS avatar_url VARCHAR(500);
```

### 创建索引
```sql
-- V003__add_indexes.sql
CREATE INDEX IF NOT EXISTS idx_users_email ON users(email);
```

### 数据迁移
```sql
-- V004__migrate_data.sql
UPDATE users SET status = 'active' WHERE status IS NULL;
```

## ⚙️ 配置文件 (refinery.toml)

```toml
[main]
db_type = "Postgres"
db_host = "localhost"
db_port = "5432"
db_user = "username"
db_pass = "password"
db_name = "database"
trust_cert = false
```

## 🦀 Rust 集成

### Cargo.toml
```toml
[dependencies]
refinery = { version = "0.8", features = ["postgres"] }
tokio-postgres = "0.7"
postgres = "0.19"
```

### 嵌入迁移
```rust
mod embedded {
    use refinery::embed_migrations;
    embed_migrations!("migrations");
}

// 执行迁移
let report = embedded::migrations::runner().run(&mut client)?;
```

## 🔧 故障排除

| 错误 | 解决方案 |
|------|----------|
| 连接失败 | 检查数据库服务和连接参数 |
| 权限错误 | 确保用户有数据库操作权限 |
| 校验和不匹配 | 迁移文件被意外修改 |
| 运行时冲突 | 使用 `spawn_blocking` |

## 📦 项目结构

```
project/
├── Cargo.toml
├── refinery.toml          # CLI配置
├── .env                   # 环境变量
├── migrations/            # 迁移文件
│   ├── V001__initial.sql
│   └── V002__update.sql
└── src/
    ├── main.rs
    └── database.rs
```

## 🎯 最佳实践

- ✅ 使用 `IF NOT EXISTS` 避免重复创建
- ✅ 生产环境使用事务模式 `-g`
- ✅ 迁移前备份数据库
- ✅ 使用干运行预览 `-f`
- ✅ 遵循命名规范 `V{版本}__{描述}.sql`
- ❌ 避免删除数据的迁移
- ❌ 不要修改已应用的迁移文件
