# Refinery å¿«é€Ÿå‚è€ƒå¡

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å®‰è£…
```bash
cargo install refinery_cli
```

### 2. åˆå§‹åŒ–é…ç½®
```bash
refinery setup
# é€‰æ‹©: 2 (PostgreSQL) â†’ localhost â†’ 5432 â†’ sxt â†’ default â†’ postgres
```

### 3. åˆ›å»ºè¿ç§»æ–‡ä»¶
```bash
# å‘½åæ ¼å¼: V{ç‰ˆæœ¬}__{æè¿°}.sql
touch migrations/V001__initial_schema.sql
```

### 4. æ‰§è¡Œè¿ç§»
```bash
refinery migrate                    # æ‰§è¡Œæ‰€æœ‰è¿ç§»
refinery migrate -f                 # å¹²è¿è¡Œï¼ˆä»…é¢„è§ˆï¼‰
refinery migrate -g                 # äº‹åŠ¡æ€§è¿ç§»
refinery migrate -t 5               # è¿ç§»åˆ°ç‰ˆæœ¬5
```

## ğŸ“ å¸¸ç”¨å‘½ä»¤

| å‘½ä»¤ | è¯´æ˜ |
|------|------|
| `refinery setup` | åˆå§‹åŒ–é…ç½®æ–‡ä»¶ |
| `refinery migrate` | æ‰§è¡Œè¿ç§» |
| `refinery migrate -f` | å¹²è¿è¡Œæ¨¡å¼ |
| `refinery migrate -g` | äº‹åŠ¡æ¨¡å¼ |
| `refinery migrate -t N` | è¿ç§»åˆ°ç‰ˆæœ¬N |
| `refinery migrate -d` | ä¸¥æ ¼æ¨¡å¼ï¼ˆæ£€æŸ¥åˆ†æ­§ï¼‰ |
| `refinery migrate -m` | ä¸¥æ ¼æ¨¡å¼ï¼ˆæ£€æŸ¥ç¼ºå¤±ï¼‰ |

## ğŸ—ƒï¸ è¿ç§»æ–‡ä»¶æ¨¡æ¿

### åŸºç¡€è¡¨åˆ›å»º
```sql
-- V001__create_users.sql
CREATE TABLE IF NOT EXISTS users (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    email VARCHAR(100) UNIQUE NOT NULL,
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
);
```

### æ·»åŠ åˆ—
```sql
-- V002__add_user_avatar.sql
ALTER TABLE users ADD COLUMN IF NOT EXISTS avatar_url VARCHAR(500);
```

### åˆ›å»ºç´¢å¼•
```sql
-- V003__add_indexes.sql
CREATE INDEX IF NOT EXISTS idx_users_email ON users(email);
```

### æ•°æ®è¿ç§»
```sql
-- V004__migrate_data.sql
UPDATE users SET status = 'active' WHERE status IS NULL;
```

## âš™ï¸ é…ç½®æ–‡ä»¶ (refinery.toml)

```toml
[main]
db_type = "Postgres"
db_host = "localhost"
db_port = "5432"
db_user = "username"
db_pass = "password"
db_name = "database"
trust_cert = false
```

## ğŸ¦€ Rust é›†æˆ

### Cargo.toml
```toml
[dependencies]
refinery = { version = "0.8", features = ["postgres"] }
tokio-postgres = "0.7"
postgres = "0.19"
```

### åµŒå…¥è¿ç§»
```rust
mod embedded {
    use refinery::embed_migrations;
    embed_migrations!("migrations");
}

// æ‰§è¡Œè¿ç§»
let report = embedded::migrations::runner().run(&mut client)?;
```

## ğŸ”§ æ•…éšœæ’é™¤

| é”™è¯¯ | è§£å†³æ–¹æ¡ˆ |
|------|----------|
| è¿æ¥å¤±è´¥ | æ£€æŸ¥æ•°æ®åº“æœåŠ¡å’Œè¿æ¥å‚æ•° |
| æƒé™é”™è¯¯ | ç¡®ä¿ç”¨æˆ·æœ‰æ•°æ®åº“æ“ä½œæƒé™ |
| æ ¡éªŒå’Œä¸åŒ¹é… | è¿ç§»æ–‡ä»¶è¢«æ„å¤–ä¿®æ”¹ |
| è¿è¡Œæ—¶å†²çª | ä½¿ç”¨ `spawn_blocking` |

## ğŸ“¦ é¡¹ç›®ç»“æ„

```
project/
â”œâ”€â”€ Cargo.toml
â”œâ”€â”€ refinery.toml          # CLIé…ç½®
â”œâ”€â”€ .env                   # ç¯å¢ƒå˜é‡
â”œâ”€â”€ migrations/            # è¿ç§»æ–‡ä»¶
â”‚   â”œâ”€â”€ V001__initial.sql
â”‚   â””â”€â”€ V002__update.sql
â””â”€â”€ src/
    â”œâ”€â”€ main.rs
    â””â”€â”€ database.rs
```

## ğŸ¯ æœ€ä½³å®è·µ

- âœ… ä½¿ç”¨ `IF NOT EXISTS` é¿å…é‡å¤åˆ›å»º
- âœ… ç”Ÿäº§ç¯å¢ƒä½¿ç”¨äº‹åŠ¡æ¨¡å¼ `-g`
- âœ… è¿ç§»å‰å¤‡ä»½æ•°æ®åº“
- âœ… ä½¿ç”¨å¹²è¿è¡Œé¢„è§ˆ `-f`
- âœ… éµå¾ªå‘½åè§„èŒƒ `V{ç‰ˆæœ¬}__{æè¿°}.sql`
- âŒ é¿å…åˆ é™¤æ•°æ®çš„è¿ç§»
- âŒ ä¸è¦ä¿®æ”¹å·²åº”ç”¨çš„è¿ç§»æ–‡ä»¶
