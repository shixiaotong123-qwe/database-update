# Refinery è¿ç§»é”™è¯¯å¤„ç†æœºåˆ¶è¯¦è§£

## ğŸ¯ æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†åˆ†æ Refinery é¡¹ç›®åœ¨è¿ç§»å‡ºé”™æ—¶çš„å®Œæ•´é”™è¯¯å¤„ç†æœºåˆ¶ï¼ŒåŒ…æ‹¬é”™è¯¯ç±»å‹åˆ†ç±»ã€å¤„ç†æµç¨‹å’Œæœ€ä½³å®è·µã€‚

## ğŸ—ï¸ é”™è¯¯å¤„ç†æ¶æ„

### é”™è¯¯å¤„ç†å±‚æ¬¡ç»“æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    åº”ç”¨ç¨‹åºå…¥å£                          â”‚
â”‚                   (main.rs)                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              æ•°æ®åº“ç®¡ç†å±‚                                â”‚
â”‚            (database.rs)                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚            è¿ç§»æ‰§è¡Œå±‚                            â”‚   â”‚
â”‚  â”‚       (safe_migrate æ–¹æ³•)                       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              é”™è¯¯å¤„ç†å±‚                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ è¿æ¥é”™è¯¯     â”‚ â”‚ è¿ç§»é”™è¯¯     â”‚ â”‚ å®Œæ•´æ€§é”™è¯¯   â”‚      â”‚
â”‚  â”‚ å¤„ç†        â”‚ â”‚ å¤„ç†        â”‚ â”‚ å¤„ç†        â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”§ ä»£ç åˆ†æ

### 1. main.rs ä¸­çš„é”™è¯¯å¤„ç†

#### é”™è¯¯åˆ†ç±»ç­–ç•¥

```rust
// è‡´å‘½é”™è¯¯ - ç«‹å³é€€å‡º
match database::connect().await {
    Ok(manager) => manager,
    Err(e) => {
        error!("âŒ æ•°æ®åº“è¿æ¥å¤±è´¥: {}", e);
        return Err(e);  // ğŸš¨ ç«‹å³é€€å‡º
    }
}

// è¿ç§»é”™è¯¯ - è‡´å‘½é”™è¯¯
match db_manager.safe_migrate(&database_url).await {
    Ok(_) => info!("âœ… Refineryæ•°æ®åº“è¿ç§»å®Œæˆ"),
    Err(e) => {
        error!("âŒ Refineryæ•°æ®åº“è¿ç§»å¤±è´¥: {}", e);
        return Err(e);  // ğŸš¨ ç«‹å³é€€å‡º
    }
}

// è­¦å‘Šé”™è¯¯ - è®°å½•ä½†ç»§ç»­æ‰§è¡Œ
match data::show_data_statistics(db_manager.get_client()).await {
    Ok(_) => info!("âœ… æ•°æ®ç»Ÿè®¡æ˜¾ç¤ºå®Œæˆ"),
    Err(e) => {
        error!("âš ï¸  æ•°æ®ç»Ÿè®¡å¤±è´¥: {}", e);
        // ğŸ”„ ç»§ç»­æ‰§è¡Œï¼Œä¸é€€å‡º
    }
}
```

#### é”™è¯¯å¤„ç†ä¼˜å…ˆçº§

| ä¼˜å…ˆçº§ | é”™è¯¯ç±»å‹ | å¤„ç†æ–¹å¼ | å½±å“ |
|--------|----------|----------|------|
| **P0 - è‡´å‘½** | æ•°æ®åº“è¿æ¥å¤±è´¥ | ç«‹å³é€€å‡º | ç¨‹åºæ— æ³•è¿è¡Œ |
| **P0 - è‡´å‘½** | è¿ç§»æ‰§è¡Œå¤±è´¥ | ç«‹å³é€€å‡º | æ•°æ®åº“çŠ¶æ€ä¸ä¸€è‡´ |
| **P0 - è‡´å‘½** | è¡¨ç»“æ„éªŒè¯å¤±è´¥ | ç«‹å³é€€å‡º | æ•°æ®åº“ç»“æ„é”™è¯¯ |
| **P1 - é‡è¦** | æ•°æ®æ’å…¥å¤±è´¥ | ç«‹å³é€€å‡º | æ•°æ®ä¸å®Œæ•´ |
| **P2 - è­¦å‘Š** | ç»Ÿè®¡ä¿¡æ¯è·å–å¤±è´¥ | è®°å½•è­¦å‘Šï¼Œç»§ç»­ | å½±å“ç›‘æ§ |
| **P2 - è­¦å‘Š** | ç´¢å¼•çŠ¶æ€æ£€æŸ¥å¤±è´¥ | è®°å½•è­¦å‘Šï¼Œç»§ç»­ | å½±å“æ€§èƒ½ç›‘æ§ |

### 2. database.rs ä¸­çš„é”™è¯¯å¤„ç†

#### è¿æ¥å±‚é”™è¯¯å¤„ç†

```rust
pub async fn new_with_config(database_url: &str) -> Result<Self> {
    info!("æ­£åœ¨ä½¿ç”¨Refineryè¿æ¥æ•°æ®åº“...");
    
    // ğŸ”Œ è¿æ¥å»ºç«‹é”™è¯¯å¤„ç†
    let (client, connection) = tokio_postgres::connect(database_url, NoTls)
        .await
        .context("æ— æ³•è¿æ¥åˆ°æ•°æ®åº“")?;  // â† anyhow::Context æä¾›è¯¦ç»†é”™è¯¯ä¿¡æ¯
    
    // ğŸ§ª è¿æ¥æµ‹è¯•é”™è¯¯å¤„ç†
    let _row = client.query_one("SELECT 1", &[])
        .await
        .context("æ•°æ®åº“è¿æ¥æµ‹è¯•å¤±è´¥")?;  // â† ç¡®ä¿è¿æ¥å¯ç”¨
    
    Ok(Self { client })
}
```

#### è¿ç§»å±‚é”™è¯¯å¤„ç†

```rust
pub async fn safe_migrate(&mut self, database_url: &str) -> Result<()> {
    info!("å¼€å§‹æ‰§è¡ŒRefineryæ•°æ®åº“è¿ç§»...");
    
    // ğŸ”„ å¤šå±‚é”™è¯¯å¤„ç†ç­–ç•¥
    let migration_result = tokio::task::spawn_blocking(move || -> Result<refinery::Report, anyhow::Error> {
        // 1ï¸âƒ£ URLè§£æé”™è¯¯
        let db_config = postgres::Config::from_str(&database_url_owned)
            .context("è§£ææ•°æ®åº“URLå¤±è´¥")?;
        
        // 2ï¸âƒ£ åŒæ­¥è¿æ¥å»ºç«‹é”™è¯¯
        let mut postgres_client = db_config.connect(postgres::NoTls)
            .context("åˆ›å»ºè¿ç§»ä¸“ç”¨è¿æ¥å¤±è´¥")?;
        
        // 3ï¸âƒ£ è¿ç§»æ‰§è¡Œé”™è¯¯
        let report = embedded::migrations::runner().run(&mut postgres_client)
            .map_err(|e| anyhow::anyhow!("Refineryè¿ç§»æ‰§è¡Œå¤±è´¥: {}", e))?;
        
        Ok(report)
    }).await
    .context("è¿ç§»ä»»åŠ¡æ‰§è¡Œå¤±è´¥")?      // 4ï¸âƒ£ å¼‚æ­¥ä»»åŠ¡æ‰§è¡Œé”™è¯¯
    .context("è¿ç§»æ“ä½œå¤±è´¥")?;        // 5ï¸âƒ£ è¿ç§»æ“ä½œçº§åˆ«é”™è¯¯
    
    // âœ… æˆåŠŸå¤„ç†
    info!("âœ… Refineryæ•°æ®åº“è¿ç§»å®Œæˆ");
    Ok(())
}
```

### 3. ä¸“é—¨çš„é”™è¯¯å¤„ç†æ–¹æ³•

#### handle_migration_failure - è¿ç§»å¤±è´¥å¤„ç†å™¨

```rust
async fn handle_migration_failure(&self) -> Result<()> {
    error!("æ­£åœ¨å¤„ç†Refineryè¿ç§»å¤±è´¥...");
    
    // ğŸ“Š ç”Ÿæˆå¤±è´¥æŠ¥å‘Š
    self.generate_failure_report().await?;
    
    // ğŸ” æ£€æŸ¥æ•°æ®å®Œæ•´æ€§
    self.check_data_integrity().await?;
    
    Ok(())
}
```

#### generate_failure_report - å¤±è´¥æŠ¥å‘Šç”Ÿæˆå™¨

```rust
async fn generate_failure_report(&self) -> Result<()> {
    let report_time = chrono::Utc::now().format("%Y-%m-%d %H:%M:%S UTC");
    
    // ğŸ“‹ è¿ç§»å†å²åˆ†æ
    let migration_history = self.client.query(
        "SELECT version, name, applied_on, checksum 
         FROM refinery_schema_history 
         ORDER BY version DESC",
        &[]
    ).await?;
    
    error!("=== Refineryè¿ç§»å¤±è´¥æŠ¥å‘Š ===");
    error!("æ—¶é—´: {}", report_time);
    error!("è¿ç§»å†å²è®°å½•æ•°é‡: {}", migration_history.len());
    
    // ğŸ” æ˜¾ç¤ºæœ€è¿‘çš„è¿ç§»è®°å½•
    for row in migration_history.iter().take(5) {
        let version: i32 = row.get("version");
        let name: String = row.get("name");
        let applied_on: chrono::DateTime<chrono::Utc> = row.get("applied_on");
        error!("  - v{}: {} ({})", version, name, applied_on.format("%Y-%m-%d %H:%M:%S"));
    }
    
    Ok(())
}
```

#### check_data_integrity - æ•°æ®å®Œæ•´æ€§æ£€æŸ¥å™¨

```rust
async fn check_data_integrity(&self) -> Result<()> {
    info!("æ£€æŸ¥æ•°æ®å®Œæ•´æ€§...");
    
    let critical_tables = vec!["users", "products", "orders"];
    
    for table in critical_tables {
        // ğŸ” è¡¨å­˜åœ¨æ€§æ£€æŸ¥
        let exists: bool = self.client.query_one(
            "SELECT EXISTS (
                SELECT FROM information_schema.tables 
                WHERE table_name = $1 AND table_schema = 'public'
            ) as exists",
            &[&table]
        ).await?.get("exists");
        
        if exists {
            // ğŸ“Š æ•°æ®é‡æ£€æŸ¥
            match self.client.query(&format!("SELECT COUNT(*) as count FROM {}", table), &[]).await {
                Ok(rows) => {
                    let count: i64 = rows[0].get("count");
                    info!("âœ… è¡¨ {} å­˜åœ¨ï¼ŒåŒ…å« {} è¡Œæ•°æ®", table, count);
                }
                Err(e) => {
                    warn!("âš ï¸  æ— æ³•æŸ¥è¯¢è¡¨ {} çš„æ•°æ®é‡: {}", table, e);
                }
            }
        } else {
            warn!("âš ï¸  å…³é”®è¡¨ {} ä¸å­˜åœ¨", table);
        }
    }
    
    Ok(())
}
```

## ğŸš¨ å®é™…é”™è¯¯åœºæ™¯æ¼”ç¤º

### åœºæ™¯1: æ–‡ä»¶ç³»ç»Ÿä¸ä¸€è‡´é”™è¯¯

```
é”™è¯¯ä¿¡æ¯: migration V10__æµ‹è¯•çœŸå®é”™è¯¯ is missing from the filesystem
é”™è¯¯åŸå› : æ•°æ®åº“è®°å½•äº†è¿ç§»ç‰ˆæœ¬ï¼Œä½†æ–‡ä»¶ç³»ç»Ÿä¸­ç¼ºå°‘å¯¹åº”çš„è¿ç§»æ–‡ä»¶
å¤„ç†æ–¹å¼: ç«‹å³é€€å‡ºï¼Œé˜²æ­¢çŠ¶æ€ä¸ä¸€è‡´
```

**å®é™…è¾“å‡ºï¼š**
```
2025-09-08T10:05:07.696622Z  INFO postgres::config: NOTICE: relation "refinery_schema_history" already exists, skipping
2025-09-08T10:05:07.698880Z ERROR main: âŒ Refineryæ•°æ®åº“è¿ç§»å¤±è´¥: è¿ç§»æ“ä½œå¤±è´¥
Error: è¿ç§»æ“ä½œå¤±è´¥

Caused by:
    Refineryè¿ç§»æ‰§è¡Œå¤±è´¥: migration V10__æµ‹è¯•çœŸå®é”™è¯¯ is missing from the filesystem
```

### åœºæ™¯2: æ•°æ®åº“è¿æ¥å¤±è´¥é”™è¯¯

```
é”™è¯¯ä¿¡æ¯: æ— æ³•è¿æ¥åˆ°æ•°æ®åº“
é”™è¯¯åŸå› : PostgreSQLæœåŠ¡æœªè¿è¡Œæˆ–è¿æ¥å‚æ•°é”™è¯¯
å¤„ç†æ–¹å¼: ç«‹å³é€€å‡ºï¼Œæ— æ³•ç»§ç»­æ‰§è¡Œ
```

### åœºæ™¯3: SQLè¯­æ³•é”™è¯¯

```
é”™è¯¯ä¿¡æ¯: syntax error at or near "TABL"
é”™è¯¯åŸå› : è¿ç§»æ–‡ä»¶ä¸­åŒ…å«æ— æ•ˆçš„SQLè¯­æ³•
å¤„ç†æ–¹å¼: è¿ç§»ä¸­æ­¢ï¼Œæ•°æ®åº“çŠ¶æ€å›æ»š
```

### åœºæ™¯4: çº¦æŸè¿åé”™è¯¯

```sql
-- é”™è¯¯ç¤ºä¾‹ï¼šå¼•ç”¨ä¸å­˜åœ¨çš„è¡¨
ALTER TABLE orders ADD CONSTRAINT fk_orders_nonexistent 
FOREIGN KEY (user_id) REFERENCES nonexistent_table(id);

-- é”™è¯¯ä¿¡æ¯ï¼šrelation "nonexistent_table" does not exist
```

## ğŸ“Š é”™è¯¯å¤„ç†æµç¨‹å›¾

```
å¼€å§‹è¿ç§»
    â”‚
    â–¼
æ£€æŸ¥æ•°æ®åº“è¿æ¥ â”€â”€âŒâ”€â”€â–º è®°å½•é”™è¯¯ â”€â”€â–º é€€å‡º(Code: 1)
    â”‚âœ…
    â–¼
è§£æè¿ç§»æ–‡ä»¶ â”€â”€âŒâ”€â”€â–º è®°å½•é”™è¯¯ â”€â”€â–º é€€å‡º(Code: 1)
    â”‚âœ…
    â–¼
æ‰§è¡Œè¿ç§»SQL â”€â”€âŒâ”€â”€â–º ç”Ÿæˆå¤±è´¥æŠ¥å‘Š â”€â”€â–º æ£€æŸ¥æ•°æ®å®Œæ•´æ€§ â”€â”€â–º é€€å‡º(Code: 1)
    â”‚âœ…
    â–¼
éªŒè¯ç»“æœ â”€â”€âŒâ”€â”€â–º è®°å½•è­¦å‘Š â”€â”€â–º ç»§ç»­æ‰§è¡Œ
    â”‚âœ…
    â–¼
è¿ç§»æˆåŠŸ â”€â”€â–º è®°å½•æˆåŠŸæ—¥å¿— â”€â”€â–º ç»§ç»­åç»­æ“ä½œ
```

## ğŸ›¡ï¸ é”™è¯¯å¤„ç†æœ€ä½³å®è·µ

### 1. é¢„é˜²æ€§æªæ–½

#### è¿ç§»å‰æ£€æŸ¥æ¸…å•
```bash
# 1. æ•°æ®åº“è¿æ¥æµ‹è¯•
psql "$DATABASE_URL" -c "SELECT 1;"

# 2. è¿ç§»æ–‡ä»¶è¯­æ³•æ£€æŸ¥
for file in migrations/*.sql; do
    echo "æ£€æŸ¥ $file"
    psql "$DATABASE_URL" -f "$file" --dry-run 2>/dev/null || echo "âš ï¸ $file æœ‰è¯­æ³•é”™è¯¯"
done

# 3. å¹²è¿è¡Œæµ‹è¯•
refinery migrate -f

# 4. å¤‡ä»½æ•°æ®åº“
pg_dump "$DATABASE_URL" > backup_$(date +%Y%m%d_%H%M%S).sql
```

#### è¿ç§»æ–‡ä»¶ç¼–å†™è§„èŒƒ
```sql
-- âœ… å¥½çš„åšæ³•
-- V001__create_users_table.sql
-- åˆ›å»ºç”¨æˆ·è¡¨å’Œç›¸å…³ç´¢å¼•

-- ä½¿ç”¨æ¡ä»¶è¯­å¥é¿å…é‡å¤åˆ›å»º
CREATE TABLE IF NOT EXISTS users (
    id SERIAL PRIMARY KEY,
    username VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(100) UNIQUE NOT NULL
);

-- ä½¿ç”¨æ¡ä»¶è¯­å¥å®‰å…¨åˆ›å»ºç´¢å¼•
CREATE INDEX IF NOT EXISTS idx_users_email ON users(email);

-- âŒ é¿å…çš„åšæ³•
-- æ²¡æœ‰æ¡ä»¶æ£€æŸ¥çš„è¯­å¥
CREATE TABLE users (id SERIAL PRIMARY KEY);  -- å¯èƒ½å¯¼è‡´é‡å¤åˆ›å»ºé”™è¯¯

-- ç›´æ¥åˆ é™¤æ•°æ®
DELETE FROM users WHERE created_at < '2020-01-01';  -- å±é™©æ“ä½œ
```

### 2. é”™è¯¯å‘ç”Ÿæ—¶çš„åº”æ€¥å“åº”

#### è¿ç§»å¤±è´¥æ¢å¤æµç¨‹

```bash
#!/bin/bash
# è¿ç§»å¤±è´¥åº”æ€¥æ¢å¤è„šæœ¬

echo "ğŸš¨ è¿ç§»å¤±è´¥åº”æ€¥æ¢å¤ç¨‹åº"

# 1. ç«‹å³å¤‡ä»½å½“å‰çŠ¶æ€
echo "ğŸ“¦ å¤‡ä»½å½“å‰æ•°æ®åº“çŠ¶æ€..."
pg_dump "$DATABASE_URL" > emergency_backup_$(date +%Y%m%d_%H%M%S).sql

# 2. æ£€æŸ¥è¿ç§»çŠ¶æ€
echo "ğŸ” æ£€æŸ¥è¿ç§»çŠ¶æ€..."
psql "$DATABASE_URL" -c "
SELECT version, name, applied_on 
FROM refinery_schema_history 
ORDER BY version DESC 
LIMIT 10;"

# 3. åˆ†æé”™è¯¯æ—¥å¿—
echo "ğŸ“‹ åˆ†æé”™è¯¯åŸå› ..."
tail -50 /var/log/application.log | grep -i error

# 4. å†³ç­–é€‰é¡¹
echo "ğŸ¯ æ¢å¤é€‰é¡¹ï¼š"
echo "1. ä¿®å¤è¿ç§»æ–‡ä»¶å¹¶é‡æ–°æ‰§è¡Œ"
echo "2. æ‰‹åŠ¨å›æ»šåˆ°ä¸Šä¸€ä¸ªç¨³å®šç‰ˆæœ¬"
echo "3. ä»å¤‡ä»½æ¢å¤æ•°æ®åº“"

read -p "é€‰æ‹©æ¢å¤æ–¹æ¡ˆ (1-3): " choice

case $choice in
    1) echo "ä¿®å¤è¿ç§»æ–‡ä»¶åé‡æ–°è¿è¡Œ refinery migrate" ;;
    2) echo "æ‰‹åŠ¨æ‰§è¡Œå›æ»šSQL" ;;
    3) echo "ä»å¤‡ä»½æ¢å¤ï¼špsql \$DATABASE_URL < backup_file.sql" ;;
esac
```

### 3. ç›‘æ§å’Œå‘Šè­¦

#### è¿ç§»ç›‘æ§è„šæœ¬
```bash
#!/bin/bash
# è¿ç§»çŠ¶æ€ç›‘æ§è„šæœ¬

DATABASE_URL="$1"
ALERT_WEBHOOK="$2"

# æ£€æŸ¥è¿ç§»çŠ¶æ€
LAST_MIGRATION=$(psql "$DATABASE_URL" -tAc "
SELECT MAX(version) FROM refinery_schema_history;
")

MIGRATION_FILES=$(ls migrations/V*.sql | wc -l)

if [ "$MIGRATION_FILES" -gt "$LAST_MIGRATION" ]; then
    PENDING=$((MIGRATION_FILES - LAST_MIGRATION))
    MESSAGE="âš ï¸ å‘ç° $PENDING ä¸ªå¾…æ‰§è¡Œçš„è¿ç§»"
    
    # å‘é€å‘Šè­¦
    curl -X POST -H 'Content-type: application/json' \
         --data "{\"text\":\"$MESSAGE\"}" \
         "$ALERT_WEBHOOK"
fi
```

## ğŸ”§ é”™è¯¯å¤„ç†æ”¹è¿›å»ºè®®

### 1. å¢å¼ºé”™è¯¯æŠ¥å‘Š

å½“å‰é¡¹ç›®ä¸­ `handle_migration_failure`ã€`generate_failure_report` å’Œ `check_data_integrity` æ–¹æ³•å­˜åœ¨ä½†æœªè¢«è°ƒç”¨ã€‚å»ºè®®åœ¨ `safe_migrate` æ–¹æ³•ä¸­é›†æˆï¼š

```rust
pub async fn safe_migrate(&mut self, database_url: &str) -> Result<()> {
    // ... ç°æœ‰ä»£ç  ...
    
    match migration_result {
        Ok(report) => {
            info!("âœ… Refineryæ•°æ®åº“è¿ç§»å®Œæˆ");
            // å¤„ç†æˆåŠŸç»“æœ...
        }
        Err(e) => {
            error!("âŒ è¿ç§»å¤±è´¥ï¼Œå¯åŠ¨é”™è¯¯å¤„ç†æµç¨‹...");
            
            // ğŸ†• è°ƒç”¨é”™è¯¯å¤„ç†æ–¹æ³•
            if let Err(handle_err) = self.handle_migration_failure().await {
                error!("é”™è¯¯å¤„ç†å™¨æœ¬èº«å‘ç”Ÿé”™è¯¯: {}", handle_err);
            }
            
            return Err(e);
        }
    }
    
    Ok(())
}
```

### 2. æ·»åŠ é‡è¯•æœºåˆ¶

```rust
async fn safe_migrate_with_retry(&mut self, database_url: &str, max_retries: u32) -> Result<()> {
    let mut attempts = 0;
    
    while attempts < max_retries {
        match self.safe_migrate(database_url).await {
            Ok(_) => return Ok(()),
            Err(e) => {
                attempts += 1;
                if attempts < max_retries {
                    warn!("è¿ç§»å¤±è´¥ï¼Œç¬¬ {} æ¬¡é‡è¯• (æœ€å¤§ {} æ¬¡): {}", attempts, max_retries, e);
                    tokio::time::sleep(tokio::time::Duration::from_secs(5 * attempts as u64)).await;
                } else {
                    error!("è¿ç§»åœ¨ {} æ¬¡å°è¯•åä»ç„¶å¤±è´¥: {}", max_retries, e);
                    return Err(e);
                }
            }
        }
    }
    
    unreachable!()
}
```

### 3. æ·»åŠ è¿ç§»é”æœºåˆ¶

```rust
async fn acquire_migration_lock(&self) -> Result<bool> {
    let result = self.client.execute(
        "INSERT INTO migration_lock (id, acquired_at) VALUES (1, NOW()) 
         ON CONFLICT (id) DO NOTHING",
        &[]
    ).await?;
    
    Ok(result > 0)
}

async fn release_migration_lock(&self) -> Result<()> {
    self.client.execute("DELETE FROM migration_lock WHERE id = 1", &[]).await?;
    Ok(())
}
```

## ğŸ“š æ€»ç»“

Refinery é¡¹ç›®å…·å¤‡äº†å®Œæ•´çš„é”™è¯¯å¤„ç†æ¡†æ¶ï¼š

### âœ… ç°æœ‰ä¼˜åŠ¿
1. **åˆ†å±‚é”™è¯¯å¤„ç†**: ä»è¿æ¥åˆ°è¿ç§»æ‰§è¡Œçš„å®Œæ•´é”™è¯¯å¤„ç†é“¾
2. **è¯¦ç»†é”™è¯¯ä¿¡æ¯**: ä½¿ç”¨ `anyhow::Context` æä¾›é”™è¯¯ä¸Šä¸‹æ–‡
3. **é”™è¯¯åˆ†ç±»**: åŒºåˆ†è‡´å‘½é”™è¯¯å’Œè­¦å‘Šé”™è¯¯
4. **ä¸“ç”¨é”™è¯¯å¤„ç†æ–¹æ³•**: å¤±è´¥æŠ¥å‘Šå’Œæ•°æ®å®Œæ•´æ€§æ£€æŸ¥

### ğŸ”§ æ”¹è¿›ç©ºé—´
1. **å®é™…è°ƒç”¨é”™è¯¯å¤„ç†æ–¹æ³•**: å°†ç°æœ‰çš„é”™è¯¯å¤„ç†æ–¹æ³•é›†æˆåˆ°ä¸»æµç¨‹ä¸­
2. **å¢åŠ é‡è¯•æœºåˆ¶**: å¯¹ä¸´æ—¶æ€§é”™è¯¯è¿›è¡Œé‡è¯•
3. **æ·»åŠ ç›‘æ§å’Œå‘Šè­¦**: å®æ—¶ç›‘æ§è¿ç§»çŠ¶æ€
4. **å¢å¼ºæ¢å¤èƒ½åŠ›**: è‡ªåŠ¨æ¢å¤å’Œæ‰‹åŠ¨æ¢å¤é€‰é¡¹

è¿™ä¸ªé”™è¯¯å¤„ç†æœºåˆ¶ä¸ºç”Ÿäº§ç¯å¢ƒçš„æ•°æ®åº“è¿ç§»æä¾›äº†å¼ºæœ‰åŠ›çš„ä¿éšœï¼
